<div class="venta-form">
  <h2>Nueva Venta</h2>

  <div class="alert" *ngIf="error">{{ error }}</div>

  <form (ngSubmit)="guardar()">
    <div class="grid">
      <div class="form-group">
        <label for="cliente">Cliente</label>
        <select id="cliente" name="cliente" [(ngModel)]="venta.cliente_id" required>
          <option value="" disabled>Selecciona un cliente</option>
          <option *ngFor="let c of clientes" [value]="c.id">{{ c.first_name }} {{ c.last_name }}</option>
        </select>
      </div>

      <div class="form-group">
        <label for="vendedor">Vendedor</label>
        <select id="vendedor" name="vendedor" [(ngModel)]="venta.vendedor_id" required>
          <option value="">Selecciona un vendedor</option>
          <option *ngFor="let u of usuarios" [value]="u.id">
            {{ u.first_name && u.last_name ? (u.first_name + ' ' + u.last_name) : u.username }}
          </option>
        </select>
        <small *ngIf="venta.vendedor_id" style="color: #4caf50; margin-top: 4px; display: block;">
          âœ“ Vendedor seleccionado
        </small>
      </div>

      <div class="form-group">
        <label for="fecha">Fecha</label>
        <input id="fecha" type="date" name="fecha" [(ngModel)]="venta.fecha" required />
      </div>

      <div class="form-group">
        <label for="notas">Notas</label>
        <textarea id="notas" name="notas" [(ngModel)]="venta.notas" rows="2"></textarea>
      </div>
    </div>

    <div class="line-items">
      <div class="add-line">
        <select [(ngModel)]="nuevoProducto.producto_id" name="producto">
          <option value="" disabled>Selecciona producto</option>
          <option *ngFor="let p of productos" [value]="p.id" [disabled]="getStockProducto(p.id) <= 0">
            {{ p.name }} - ${{ p.sale_price }} (Stock: {{ getStockProducto(p.id) }})
          </option>
        </select>
        <input type="number" min="1" [(ngModel)]="nuevoProducto.cantidad" name="cantidad" />
        <button type="button" (click)="agregarProducto()">Agregar</button>
      </div>

      <table *ngIf="lineas.length > 0">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Cantidad</th>
            <th>Precio</th>
            <th>Subtotal</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let l of lineas; let i = index">
            <td>{{ l.producto_nombre }}</td>
            <td>{{ l.cantidad }}</td>
            <td>{{ l.precio_unitario | currency:'USD':'symbol' }}</td>
            <td>{{ l.subtotal | currency:'USD':'symbol' }}</td>
            <td><button type="button" (click)="eliminarLinea(i)">Eliminar</button></td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <td colspan="3" class="right">Total</td>
            <td colspan="2">{{ total | currency:'USD':'symbol' }}</td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="form-actions">
      <button type="submit" [disabled]="loading">{{ loading ? 'Guardando...' : 'Guardar' }}</button>
      <button type="button" class="secondary" (click)="cancelar()">Cancelar</button>
    </div>
  </form>
</div>
